# OpenIPC для Xiaomi MJSXJ03HL (В РАЗРАБОТКЕ!!!) 
![Изображение](https://user-images.githubusercontent.com/88727968/222164240-66044bf1-16da-4ea2-af38-6fd3d3fb1b92.png)


Внимание! Любые вносимые изменения лишают вас гарантии на данное устройство! Ответственность за любой ущерб, возникший в результате любых действий пользователя, автор не несет!
_________
## Подготовка
### Подключение UART переходника

Нам понадобятся:

- Компьютер с USB портом 
- Тестер или вольтметр
- UART переходник на 3,3V , подобный этому

![изображение](https://user-images.githubusercontent.com/88727968/222174358-5203eb83-14ce-4f55-89bd-24775af82599.png)

Все действия будут показаны на ОС Linux (Kubuntu), если Ваша ОС отличается, пожалуйста обратитесь к специализированным инструкциям по настройке UART в вашей ОС.

Порядок работы:
1) Внимательно изучите UART переходник. Найдите контакты `GND`,`TX`,`RX`. Если ваш переходник поддерживает функцию выбора рабочего напряжения, убедитесь, что он переведен в режим работы 3,3V! 
2) При помощи тестера убедитесь в том, что Ваш UART переходник выдает напряжение 3.3V. Для этого выполните замеры между контактами `GND`и`TX`, а также `GND`и`RX`. Не используйте переходник, если величина напряжения составляет 5V! Это убьет Вашу камеру!
3) Подключите UART переходник к порту Вашего компьютера. Необходимо узнать точку монтирования переходника в Вашей операционной системе.
4) Используйте терминал. Выполните команду `lsusb` и внимательно изучите вывод. Найдите Ваш UART переходник.
5) Используйте терминал. Выполните команду `dmesg | grep attached` от суперпользователя. Сравните выводы обеих команд и найдите точку монтирования переходника. Для примера воспользуйтесь скриншотом ниже: ![Screenshot_20230301_210433](https://user-images.githubusercontent.com/88727968/222186693-932e241c-5f92-4876-b4de-e51271ea6ae9.png)
6) Итак, мы получили, что наше устройство монтируется по адресу `/dev/ttyUSB0`. В вашем случае адрес монтирования может отличаться. Этот адрес мы будем использовать при подключении через UART. Будьте внимательны, при подключении нескольких подобных устройств, а также при некорректном отключении, адрес монтирования может меняться.
________

### Разборка

В настоящее время камера поддерживает только прошивку через UART адаптер, поэтому для выполнения операций нам придется разобрать камеру.
**Помните, что это лишит вас гарантии производителя!** 

Нам понадобятся:
- Само устройство
- Фен или другое нагревательное устройство
- Плоский тонкий предмет, например канцелярский нож
- Длинная тонкая отвертка x-type
- Аккуратность

Итак, преступим:
1) Аккуратно прогрейте лицевую часть камеры (там, где объектив)
2) При помощи канцелярского ножа или иного заостренного предмета аккуратно подденьте лицевую часть. Помните, под лицевой частью находятся важные провода, ***не повредите их!***
3) Двигаясь по кругу, аккуратно отделите лицевую часть от корпуса камеры. ***Помните о том, что она соединена проводами с главной платой камеры!***
4) Под низом вы найдете два болта, котрые необходимо открутить. После этого аккуратно разъедините половинки корпуса камеры. Будьте осторожны, не причините себе вреда и не повредите соединительные провода, а также детали камеры!
5) Отверните еще несколько винтов, освободив главную плату устройства. Также освободите type С порт
 ______________

### Изучение
Внимательно изучите камеру, найдите необходимые элементы, потому что на следующих этапах нам придется физически взаимодействовать с некоторыми из них.
Производитель может менять некоторые компоненты устройства без уведомления потребителей. По этой причине две камеры, выпущенные в разное время, могут иметь разную начинку и отличающееся программное обеспечение. Поэтому еще раз внимательно изучите компоненты, убедитесь что они соответствуют тем, что указаны в данном руководстве. При возникновении вопросов, пожалуйста обратитесь в наш [Телеграм-канал](https://t.me/openipc_modding)

##### Главная плата (вид с лицевой стороны)
![IMG_20210904_194002](https://user-images.githubusercontent.com/88727968/222473262-913af0d1-0fee-4ae6-843f-256784381163.jpg)Главная плата (вид с лицевой стороны). 

Самая важная для нас часть на ней - чип памяти.
##### Чип памяти на ней
![IMG_20210904_194034](https://user-images.githubusercontent.com/88727968/222473270-dfb08412-0019-4a57-aecc-3820421263e8.jpg)Чип памяти на ней.

Он имеет численно-буквенную маркировку. Убедитесь что чип на  вашей плате имеет подобную маркировку! Число 128 означает число бит памяти. 128/8=16, значит наша память 16 Мб. Выбирать прошивку нужно под этот тип памяти!
##### Главная плата (вид с тыльной стороны)
![IMG_20210904_194151](https://user-images.githubusercontent.com/88727968/222473288-c3efcdc6-2691-452f-aebb-9ab1789d4d2d.jpg)Главная плата (вид с тыльной стороны). 

Здесь расположен беспроводной модуль, центральный процессор и различные другие компоненты. Но самое важное для нас - три контакта с отверстием, расположенные рядом в правой верхнем секторе платы. Именно через них мы подаем управляющие сигналы на камеру.

##### Центральный процессор
![IMG_20210904_194132](https://user-images.githubusercontent.com/88727968/222473285-9c00e6d9-f585-4481-a48b-867b0c1f3a85.jpg)Центральный процессор. 

В нашем случае он имеет численно-буквенную маркировку. Ingenic T31N. Буква N - серия. Она указана во втором ряду. [Подробнее](https://wiki.openipc.org/en/installation.html#step-1-determine-the-system-on-chip)
_______________
### Соединение камеры и UART-переходника

Для того, чтобы присоединить UART-переходник к плате камеры, нужно воспользоваться проводами с клеммами. Они могут идти в комплекте с UART-переходником. Однако их можно заменить аналогичными. Похожие типы соединения встречаются во множестве элетроники. Второй конец провода к плате стоит припаять, чтобы контакт не исчез в нужный момент. Будьте внимательны при пайке, не повредите элементы схемы и не замкните контакты между собой!
![IMG_20210904_1941511](https://user-images.githubusercontent.com/88727968/222906480-dea0a59c-2dab-45e3-96fa-81cf335b745b.jpg)

Соедините провода, идущие от UART-переходника с платой так, как показано на рисунке. Если вы все сделали правильно, камера будет показывать лог во время  загрузки. Проверим это.

#### Проверка работоспособности терминала, камеры и соединения

Для начала нам потребуется установить программу-терминал для отправки управляющих команд с камеры и приема обратных сигналов. В ОС linux достаточно большое количество терминалов, вы можете выбрать себе наиболее удобный. Среди них можно выделить **screen, picocom, minicom, cutecom**. Последний имеет GUI.
Установите программу-терминал:
```sudo apt install <ИМЯПАКЕТА>```
Команды будут приведены для программы picocom.
Для начала ознакомьтесь с возможностями программы и синтаксисом команд:
```picocom --help``` 
Подключите UART-переходник и выполните в терминале команду:
```
picocom -b 115200 /dev/ttyUSB0
```
где опция `-b` задает управляющую частоту, а `/dev/ttyUSB0` - адрес точки монтирования, который мы узнали ранее.
Если вы все сделали верно, программа напишет, что терминал готов к работе. Ознакомьтесь с управляющими командами терминала, нажав последовательность клавиш `Ctrl+A   Ctrl+H`. Для более подробного изучения программы-терминала обратитесь к соответствующим руководствам в сети.

Если вы подадите питание на камеру, то увидите лог загрузки. Попробуйте нажать клавиши, например `Enter` и убедитесь, что терминал на них реагирует и отправляет события. Если все сделано верно, можно переходить к следующему пункту.
_____________

### Получение доступа к консоли загрузчика
К сожалению, камера MJSXJ03HL не поддерживает прерывание загрузки через отправку комбинации клавиш. По этой причине прерывание загрузки и получение доступа к консоли загрузчика будет призводиться нами вручную. Для этого необходимо будет замкнуть некоторые контакты [чипа памяти](https://github.com/OpenIPC/device-mjsxj03hl/edit/master/docs/ru_index.md#%D1%87%D0%B8%D0%BF-%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D0%B8-%D0%BD%D0%B0-%D0%BD%D0%B5%D0%B9).
О том, как это сделать, прочтите [здесь](https://wiki.openipc.org/en/faq.html#how-to-get-into-bootloader-shell).
Внимательно изучите приведенный выше мануал, найдите чип памяти и нужные контакты, приготовьте то, чем будете замыкать контакты. Все манипуляции придется производить достаточно быстро.
ВНИМАНИЕ!!! Всю ответственность за производимые вами действия принимаете на себя! 
Далее последовательность действий по получению доступа к консоли загрузчика:
1. Соедините камеру с UART-переходником
2. Соедините UART-переходник c USB портом компьютера.
3. Запустите терминал на компьютере, убедитесь что он видит UART-переходник
4. Приготовьтесь замкнуть контакты
5. Подайте питание на плату
6. В окне терминала должен появиться лог загрузки
7. Замкните контакты чипа памяти (Это нужно сделать спустя 0,5-1 сек после подачи питания)
8. Загрузка должна прерваться. Контакты можно разомкнуть.
9. Если вы все сделали правильно, на экране появится консоль U-boot c символом `#` и возможностью ввода.
10. Введите `help` чтобы вывести список команд, присутствующих в загрузчике

К сожалению производитель для данной камеры сильно граничил возможности U-boot, это создаст нам серию препятствий в дальнейшем, пока мы не прошьем U-boot от OpenIPC. Но сперва нам следует сохранить стоковую прошивку камеры.
__________
### Сохранение заводской прошивки
Внимание! Не пропускайте этот пункт! Бэкап заводской прошивки позволит вам восстановить работоспособность устройства, если вдруг что-то пойдет не так.

Нам понадобятся:

- Камера в разобранном виде с подключенным UART
- Компьютер
- SD карта емкостью не менее 16 Мб
Предварительно рекомендуется ознакомиться с [исходной статьей](https://wiki.openipc.org/ru/help-uboot.html#%D1%81%D0%BE%D1%85%D1%80%D0%B0%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BF%D1%80%D0%BE%D1%88%D0%B8%D0%B2%D0%BA%D0%B8-%D1%87%D0%B5%D1%80%D0%B5%D0%B7-sd-%D0%BA%D0%B0%D1%80%D1%82%D1%83)

ВНИМАНИЕ! В ходе следующих манипуляций вся информация с SD карты окажется недоступной, а самой картой нельзя будет пользоваться до форматирования! Все данные, находящиеся на карте будут безвозвратно утеряны!

Карту необходимо вставить в слот камеры. UART-переходник должен быть присоединен к компьютеру, а программа-терминал запущена.

1) Прерываем загрузку камеры путем замыкания контактов, попадаем в консоль загрузчика.
2) Если SD карта была вставлена после прерывания загрузки, выполните `mmc rescan`
3) Для начала очистим требуемое пространство для записи туда дампа исходной прошивки: 
```
mmc dev 0
mmc erase 0x10 0x8000
```
4) Теперь вам надо скопировать содержимое прошивки из микросхемы флэш-памяти в оперативную память камеры. Для этого очистите участок оперативной памяти, получите доступ к микросхеме флэш-памяти и скопируйте весь объем флэш-памяти в очищенное пространство оперативной памяти. После чего сохраните скопированные данные из оперативной памяти на карту. Команды вставлять построчно!
```
mw.b 0x80600000 ff 0x1000000
sf probe 0
sf read 0x80600000 0x0 0x1000000
mmc write 0x80600000 0x10 0x8000
```
_где `0x80600000` - Стартовый адрес для Ingenic T31N._

Извлеките карту из камеры и вставьте в компьютер с ОС Linux. Используя команду `dd`, скопируйте данные с карты в бинарный файл на диске компьютера.
```
dd bs=512 skip=16 count=32768 if=/dev/sdc of=./fulldump.bin
```
_Внимание! Точка монтирования `sdc` может отличаться (sda, sdb), в зависимости от подключенного оборудования вашего компьютера._
_________
## Прошивка
### Генерация прошивки
Для получения прошивки и инструкций, воспользуйтесь [автоматическим генератором инструкция для нашего процессора](https://openipc.org/cameras/vendors/ingenic/socs/t31n)
Заполните Требуемые поля и укажите свой MAC адрес. 
![изображение](https://user-images.githubusercontent.com/88727968/223147951-c72fdd86-eaf8-415e-b17e-82026739aa96.png)
Сгенерируйте прошивку. Внимательно изучите страницу с прошивкой и инструкциями.
К сожалению, производитель не добавил в заводской загрузчик программу tftp, следовательно шить нашу прошивку мы будем по частям и вручную.
Перейдите в раздел **В качестве альтернативы прошивайте прошивку OpenIPC по частям.** и загрузите двоичный файл загрузчика по ссылке. У вас должен получиться бинарный файл **u-boot-t31n-universal.bin**. Не закрывайте страницу с инструкциями. Она нам позже еще понадобится.

Поместите полученный файл на свою SD карту. **ВНИМАНИЕ!** Если вы используете ту же самую карту памяти, что и в прошлом пункте, предварительно отформатируйте ее в Файловой системе Fat32 c таблицей MBR (MS-DOS). Не используйте таблицу GPT! Если вы используете ОС Windows - это самое обычное форматирование. Просто подключите карту памяти и Windiows сама предложит ее отформатировать.
_________________

### Прошивка загрузчика (UBoot)
Итак, мы имеем нашу камеру, подключенную к UART, в слот которой вставлена карта памяти, отформатированная в Fat32 c бинарным файлом загрузчика на ней.
На всякий случай выполним 
```
mmc rescan
```
и дополнительно проверим, что вы все сделали правильно
```
fatls mmc 0:1
```
Должны выйти данные вашей карты памяти. Если вышли какие-либо ошибки, не продолжайте до тех пор, пока они не будут устранены! В противном случае перепрошивка камеры будет возможно только на специальном оборудовании.

В начале введем переменные окружения командой `setenv`
```
setenv baseaddr 0x80600000
setenv flashsize 0x1000000
```
Заводской загрузчик не поддерживает сохранение переменных, поэтому если камера была перезагружена, вводить придется по-новой.

Теперь приступаем к самому ответственному моменту - прошивке U-Boot. Вставляйте команды построчно! Внимательно следите, чтобы команды не возвращали ошибок! Не продолжайте, если что-то пойдет не так, не пробуйте перезагрузить камеру, попросите помощи в нашем [Телеграм-канале](https://t.me/openipc_modding)
```
mw.b ${baseaddr} 0xff 0x50000
sf probe 0
sf erase 0x0 0x50000
fatload mmc 0:1 ${baseaddr} u-boot-t31n-universal.bin
sf write ${baseaddr} 0x0 ${filesize}
```
Если всё прошло успешно, то у вас теперь новый загрузчик от OpenIPC, поддерживающий все необходимые команды.
Скомандуйте `reset` в консоли загрузчика, камера перезагрузится. Теперь загрузку камеры можно прерывать нажатием комбинации `Ctrl+C`
________________

### Установка OpenIPC

Теперь, когда у нас есть загрузчик с нужным набором команд, мы можем прошить остальную часть прошивки.
Вернитесь на страницу с инструкциями, которую мы получили в пункте [Генерация прошивки](https://github.com/OpenIPC/device-mjsxj03hl/edit/master/README_ru.md#%D0%B3%D0%B5%D0%BD%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D0%BF%D1%80%D0%BE%D1%88%D0%B8%D0%B2%D0%BA%D0%B8)
Далее в разделе **Flash OpenIPC Linux kernel and root filesystem** Загрузите архив по ссылке _Download OpenIPC Firmware (Ultimate) bundle_
В нем вы найдете 4 файла: образ корневой ФС и ядро, а также контрольные суммы к ним. Разархивируйте их на вашу карту памяти и поместите ее в слот камеры.

Далее:
1) Подключаем UART, запускаем терминал!
2) Подаем питание на камеру и быстро останавливаем загрузку нажатием `Ctrl+C`. Попадаем в консоль загрузчика
3) Проверяем доступ к карте памяти 
```
mmc rescan
```
4)Вводим переменные окружения и сохраняем их:
```
setenv baseaddr 0x80600000
setenv flashsize 0x1000000
saveenv
```
5) Переназначаем разделы ПЗУ в соответствии с размером и типом флэш-памяти.
```
run setnor16m
```
6) Прошиваем ядро (Команды вводятся построчно!)
```
mw.b ${baseaddr} 0xff 0x200000
sf probe 0
sf erase 0x50000 0x300000
fatload mmc 0:1 ${baseaddr} uimage.${soc}
sf write ${baseaddr} 0x50000 ${filesize}
```
7) Прошиваем корневую файловую систему (Команды вводятся построчно!)
```
mw.b ${baseaddr} 0xff 0x500000
sf probe 0
sf erase 0x350000 0xa00000
fatload mmc 0:1 ${baseaddr} rootfs.squashfs.${soc}
sf write ${baseaddr} 0x350000 ${filesize}
```
8) Скомандуем `reset` и камера перезагрузится с новой прошивкой. 

Если вы все сделали верно, в окне терминала появится:
```
Welcome to OpenIPC
openipc-t31 login: 
```
Введите логин `root` , вход без пароля
![изображение](https://user-images.githubusercontent.com/88727968/223940074-c9f63e1a-b19c-4905-a7fb-66faca1aca52.png)

В полученном поле для ввода скомандуйте 
```
firstboot
```
**Поздравляем с успешной установкой OpenIPC!**
______________
## Настройка
### Предварительная настройка

В начале рекомендую ознакомиться с [общими правилами настройки OpenIPC](https://github.com/OpenIPC/wiki/blob/master/ru/configuration.md#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-openipc)

Предварительная настройка камеры MJSXJ03HL отличается от настройки большинства камер. В данный момент камера не может подключиться к интернету и использовать SSH мы не можем. Также не можем использовать WEB-интерфейс. Поэтому все команды пока будут выполняться в терминальном доступе к камере. Синтаксис команд в этом случае не отличается.

#### Подгрузка драйвера

Итак, подключите вашу камеру к компьютеру через UART, войдите в терминал и подайте питание на камеру. ЗАГРУЗКУ НЕ ПРЕРЫВАЕМ! 

Обратите внимание на лог загрузки. В нем возможны такие строчки:
 ```
Starting network: ip: SIOCGIFINDEX: No such device
insmod: can't insert '/lib/modules/rtl8189ftv.ko': No such file or directory
FAIL
```
В таком случае нам необходимо вручную добавить драйвер для беспроводного модуля.
Драйвер, с которым у меня удалось настроить сеть можно загрузить по [ссылке](https://github.com/OpenIPC/device-mjsxj03hl/raw/master/flash/autoconfig/lib/modules/rtl8189ftv.ko)

Скопируйте драйвер на SD карту, поместите ее в память камеры, подключите UART, терминал, подайте напряжение. Войдите в консоль камеры (не U-Boot!)
Авторизуйтесь и введите следующие команды:
1. Идем на флешку
```
cd /mnt/mmcblk0p1
``` 
2. Убеждаемся что файл присутствует
```
ls -l
```
3. Копируем
```
cp rtl8189ftv.ko /lib/modules/
```
Пока нет смысла перезагружать и проверять работу сети, переходим к следующему этапу 
#### Конфигурация сети
Сетевая конфигурация у нас расположена в файле /etc/network/interfaces.d
К сожалению, из текстовых редакторов доступен только `vi` Рекомендую предварительно ознакомиться с нюансами работы данного редактора.

Скомандуем 
``` 
vi /etc/network/interfaces.d
```
И приведем его содержимое к виду: *

```
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 192.168.1.99
    netmask 255.255.255.0
    gateway 192.168.1.1
    hwaddress ether $(fw_printenv -n ethaddr || echo XX:XX:XX:XX:XX:XX)
    pre-up echo -e "nameserver 77.88.8.8\nnameserver 8.8.4.4\n" >/tmp/resolv.conf
    pre-up echo -e "server 0.time.openipc.org iburst\nserver 1.time.openipc.org iburst\nserver 2.time.openipc.org iburst\nserver 3.ti

auto wlan0
iface wlan0 inet dhcp
    pre-up modprobe mac80211
    pre-up insmod /lib/modules/rtl8189ftv.ko
    pre-up wpa_passphrase "SSID" "PASSWORD" >/tmp/wpa_supplicant.conf
    pre-up sed -i '2i \\tscan_ssid=1' /tmp/wpa_supplicant.conf
    pre-up sleep 1
    pre-up wpa_supplicant -B -D nl80211 -i wlan0 -c/tmp/wpa_supplicant.conf
    post-down killall -q wpa_supplicant

#source-dir /etc/network/interfaces.d
```
_* ВНИМАНИЕ! Я использую статическую маршрутизацию. Вы можете оставить этот (первый) блок стандартным. `SSID` и `PASSWORD` - ваши для подключения к роутеру. Также не забудьте указать MAC адрес вашей камеры_

Сохраните изменения (убедитесь что вы все сделали верно) и перезагрузите камеру. Сеть должна появиться. Войдите в веб-интерфейс и выполните настройки, как описано в [статье](https://github.com/OpenIPC/wiki/blob/master/ru/configuration.md#%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF-%D0%B2-%D0%B2%D0%B5%D0%B1-%D0%B8%D0%BD%D1%82%D0%B5%D1%80%D1%84%D0%B5%D0%B9%D1%81).

#### Чиним Majestic Streamer

Войдите в консоль камеры по SSH или через UART. О том, как использовать SSH написано [здесь](https://github.com/OpenIPC/wiki/blob/master/ru/configuration.md#%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF-%D0%B2-%D1%88%D0%B5%D0%BB%D0%BB)

Для начала отключим HLS
```
cli -s .hls.enabled false
```
Затем задайте некоторые переменные:
```
fw_setenv bootargs 'mem=34M@0x0 rmem=30M@0x2200000 console=ttyS1,115200n8 panic=20 root=/dev/mtdblock3 rootfstype=squashfs init=/init mtdparts=jz_sfc:256k(boot),64k(env),3072k(kernel),10240k(rootfs),-(rootfs_data) nogmac'
```
И затем перезагружаем: `reboot`
Теперь видео должно заработать.

#### Прописываем путь к накопителю
В веб-интерфейсе выбираем Majestic --> Recording и прописываем туда путь к вашей карте, то есть в нашем случае приводим поле к виду:
```
/mnt/mmcblk0p1/%Y/%m/%d/%H.mp4
```
Перезагружаем и убеждаемся, что камера записывает видео на карту памяти.

#### Ночной режим
Настройте ночной режим, как показано на скриншоте. Обратите внимание на значения полей! 
![photo_2023-03-12_21-16-53](https://user-images.githubusercontent.com/88727968/224554161-4f69f333-c3ef-4ed0-8f04-5c504bec5009.jpg)

